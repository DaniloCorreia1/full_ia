{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistente</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-image: url('{% static "img/background.jpg" %}');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            color: #fff;
            font-family: 'Arial', sans-serif;
            min-height: 100vh; /* Garante que o body ocupe pelo menos a altura da tela */
        }

        .chat-container {
            margin: 50px auto;
            max-width: 600px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(112, 184, 176, 0.5);
            min-height: 500px; /* Altura mínima para o container do chat */
        }
        .chat-box {
            height: 600px;
            overflow-y: auto;
            padding: 20px;
            background-color: #3131319f;
            border-top: 5px solid #239a9e;
            border-radius: 15px 15px 0 0;
            color: #239e9e;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .message {
            margin: 10px 0;
            padding: 15px;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .bot-message {
            background-color: #242424;
            color: aqua;
            align-self: flex-start;
            display: flex;
            align-items: center;
        }
        .user-message {
            background-color: #239a9e;
            color: #ffffff;
            align-self: flex-end;
            margin-left: auto;
            display: flex;
            align-items: center;
        }
        .message i {
            margin-right: 8px; /* Espaço entre o ícone e a mensagem */
        }
        .input-group {
            padding: 15px;
            background: #2c2b2b00;
            border-top: 5px solid #239a9e;
            position: relative;
        }
        .input-group select,
        .input-group input[type="text"] {
            z-index: 1;
        }
        #send-button {
            z-index: 2;
        }
        #audio-input {
            display: none;
        }
        .message:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        #clear-chat-button {
            margin-top: 10px;
        }
        h2 {
            color: #ffffff;
        }
        .form-control{
            background-color: #2424240e; /* Fundo da caixa */
            color: aqua; /* Cor do texto */
            border: 1px solid aqua; /* Cor da borda */
            appearance: none; /* Remove o estilo padrão do select */
            -webkit-appearance: none; /* Para navegadores Webkit */
            -moz-appearance: none; /* Para navegadores Firefox */
            padding-right: 2rem; /* Espaço extra para o ícone da setinha */
            position: relative;
        }
        .form-control:focus {
            background-color: #2424240e; /* Fundo ao clicar no select */
            color: aqua; /* Cor do texto ao clicar */
            border-color: aqua; /* Cor da borda ao clicar */
            outline: none; /* Remove o outline padrão */
        }
        .form-select {
            background-color: #2424240e; /* Fundo da caixa */
            color: aqua; /* Cor do texto */
            border: 1px solid aqua; /* Cor da borda */
            appearance: none; /* Remove o estilo padrão do select */
            -webkit-appearance: none; /* Para navegadores Webkit */
            -moz-appearance: none; /* Para navegadores Firefox */
            padding-right: 2rem; /* Espaço extra para o ícone da setinha */
            position: relative;
            
            
        }

        .form-select:focus {
            background-color: #2424240e; /* Fundo ao clicar no select */
            color: aqua; /* Cor do texto ao clicar */
            border-color: aqua; /* Cor da borda ao clicar */
            outline: none; /* Remove o outline padrão */
        }

        .form-select option {
            background-color: #242424; /* Cor do fundo das opções */
            color: aqua; /* Cor do texto das opções */
        }

        /* Remove o estilo da setinha no IE/Edge */
        .form-select::-ms-expand {
            display: none;
        }

        /* Para adicionar uma setinha customizada */
        .form-select:after {
            content: '▼'; /* Caracter da setinha */
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: aqua; /* Cor da setinha */
        }


        .code-container {
            background-color: #e9ecef;
            border-radius: 10px;
            padding: 20px;
            overflow: auto; /* Permite rolagem se necessário */
            max-height: 400px; /* Limita a altura do container */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        pre {
            margin: 0; /* Remove margem para melhor alinhamento */
            white-space: pre-wrap; /* Quebra de linha automática */
            word-wrap: break-word; /* Quebra palavras longas */
        }

        @media (max-height: 700px) {
            .chat-box {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container chat-container">
        <h2 class="text-center mt-3">Assistente</h2>
        <div class="chat-box d-flex flex-column" id="chat-box">
            <!-- Mensagens aparecerão aqui -->
        </div>
        <div class="input-group mt-3">
            <select class="form-select" id="mode-select" aria-label="Modo de envio">
                <option value="text">Texto</option>
                <option value="audio_to_text">Áudio para Texto</option>
                <option value="text_to_audio">Texto para Áudio</option>
                <option value="generate_image">Gerar Imagem</option>
            </select>
            <i class="fas fa-folder" id="upload-button" style="display: none; cursor: pointer; color: aqua; font-size: 24px; margin: 10px;" > Clique</i>
            <input type="text" class="form-control" id="message-input" placeholder="Digite sua mensagem..." aria-label="Digite sua mensagem...">
            <input type="file" id="audio-input" class="d-none">
            <button class="btn btn-success" id="send-button" style="border-radius: 0px 20px 20px 0px; background-color: #239a9e;">Enviar <i class="fas fa-paper-plane"></i></button>
            
        </div>
        <div class="text-center mt-2">
            <button class="btn btn-outline-danger w-70" id="clear-chat-button" style="border-radius: 20px; margin-bottom: 10px;">Limpar Chat</button>
        </div>
        
    </div>

    <script>
        const chatBox = document.getElementById('chat-box');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const modeSelect = document.getElementById('mode-select');
        const audioInput = document.getElementById('audio-input');
        const uploadButton = document.getElementById('upload-button');
    
        modeSelect.addEventListener('change', function() {
            const isAudioToText = modeSelect.value === 'audio_to_text';
            const isTextToAudio = modeSelect.value === 'text_to_audio';
    
            audioInput.classList.toggle('d-none', !isAudioToText); // Mostra/Esconde o input de áudio
            uploadButton.style.display = isAudioToText ? 'inline-block' : 'none'; // Mostra/Esconde o botão de upload
            messageInput.classList.toggle('d-none', isAudioToText); // Mostra/Esconde o input de texto
        });
    
        uploadButton.addEventListener('click', () => {
            audioInput.click(); // Aciona o clique no input de arquivo
        });
    
        audioInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                appendMessage('user', `Áudio enviado: ${file.name}`);
                const formData = new FormData();
                formData.append('audio_file', file);
                formData.append('mode', 'audio_to_text');
                sendMessage(formData); // Envia o arquivo como mensagem
            }
        });
    
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    
        function loadChatHistory() {
            const chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
            chatHistory.forEach(chat => {
                appendMessage(chat.sender, chat.message);
            });
        }
    
        function appendMessage(sender, message) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender === 'bot' ? 'bot-message' : 'user-message');
    
            const icon = sender === 'bot' ? '<i class="fas fa-robot"></i>' : '<i class="fas fa-user"></i>';
            messageDiv.innerHTML = `${icon} ${message}`;
    
            const wrapperDiv = document.createElement('div');
            wrapperDiv.classList.add('d-flex');
            wrapperDiv.appendChild(messageDiv);
            
            chatBox.appendChild(wrapperDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    
        function simulateTyping(message) {
            const typingIndicator = document.createElement('div');
            typingIndicator.classList.add('message', 'bot-message');
            typingIndicator.innerHTML = '<i class="fas fa-robot"></i> Digitando...';
            chatBox.appendChild(typingIndicator);
            chatBox.scrollTop = chatBox.scrollHeight;
    
            const typingDuration = Math.min(3000, message.length * 100);
    
            setTimeout(() => {
                chatBox.removeChild(typingIndicator);
                appendMessage('bot', message);
                saveChatHistory('bot', message);
            }, typingDuration);
        }
    
        function sendMessage(formData) {
            fetch('', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.response) {
                    simulateTyping(data.response);
                } else if (data.image_url) {
                    const imageMessage = `Imagem gerada: <img src="${data.image_url}" alt="Imagem" style="max-width: 100%;">`;
                    appendMessage('bot', imageMessage);
                    saveChatHistory('bot', imageMessage);
                } else if (data.audio_url) {
                    const audioMessage = `Áudio gerado: <audio controls><source src="${data.audio_url}" type="audio/mpeg"></audio>`;
                    appendMessage('bot', audioMessage);
                    saveChatHistory('bot', audioMessage);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
            });
        }
    
        function saveChatHistory(sender, message) {
            const chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
            chatHistory.push({ sender, message });
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
        }
    
        sendButton.addEventListener('click', (e) => {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (message) {
                appendMessage('user', message);
                saveChatHistory('user', message);
                messageInput.value = '';
    
                const mode = modeSelect.value;
                const formData = new FormData();
                formData.append('message', message);
                formData.append('mode', mode);
                
                sendMessage(formData);
            }
        });
    
        loadChatHistory();
    
        document.getElementById('clear-chat-button').addEventListener('click', () => {
            localStorage.removeItem('chatHistory');
            chatBox.innerHTML = '';
        });
    </script>
    
</body>
</html>
